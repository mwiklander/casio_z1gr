/*
	CASIO Z1/FX-890P emulator
	BIOS
*/

#include <stdio.h>
#include <string.h>
#include "z1.h"

/*
	サブルーチンコールをエミュレートする
*/
int i86subroutine(I86stat *cpu, uint32 address)
{
	Z1stat *z1;
	int i;

	if(address < 0xe0000)
		return FALSE;

	/*printf("addressr=%06x\n", address);*/

	z1 = cpu->i.user_data;

	switch(address) {
	case 0xe4d69: /* 画面をクリアする */
		memset(z1->vram.vram, 0, sizeof(z1->vram.vram));
		break;
	case 0xe50ba: /* フォントデータの先頭アドレスを得る */
		cpu->r16.es = 0xe000;
		cpu->r16.di = 0x0000;
		break;
	case 0xe50c3: /* 海外モデルのフォントデータの先頭アドレスを得る */
		cpu->r16.es = 0xe000;
		cpu->r16.di = 0x0708;
		break;
	case 0xffff0: /* リセット */
		for(i = 0; i < 0x400; i += 4) {
			i86write16(cpu, 0x0000, i + 0, 0x0000);
			i86write16(cpu, 0x0000, i + 2, 0xf000);
		}
		i86out16(cpu, 0x00a0, 0x0000);
		i86out16(cpu, 0x00a2, 0x080a);
		i86out16(cpu, 0x00a4, 0xe000);
		i86out16(cpu, 0x00a6, 0xffce);
		i86out16(cpu, 0x00a0, 0x0000);
		i86out16(cpu, 0x00a2, 0x200a);
		i86out16(cpu, 0x0082, 0x0000);
		i86out16(cpu, 0x0080, 0x0000);
		i86out16(cpu, 0x0086, 0x0000);
		i86out16(cpu, 0x0084, 0x0000);
		i86out8(cpu, 0x003c, 0xff);
		i86out8(cpu, 0x003c, 0xff);
		i86out8(cpu, 0x003c, 0xff);
		i86out8(cpu, 0x003c, 0xff);
		i86out16(cpu, 0x0080, 0x8000);
		i86out16(cpu, 0x0082, 0xa00a);
		i86out8(cpu, 0x003c, 0xff);
		i86out8(cpu, 0x003c, 0xff);
		i86out8(cpu, 0x003c, 0xff);
		i86out16(cpu, 0x0082, 0x8000);
		i86out16(cpu, 0x0084, 0x4000);
		i86out16(cpu, 0x0086, 0x480a);
		i86out8(cpu, 0x003c, 0xff);
		i86out8(cpu, 0x003c, 0xff);
		i86out8(cpu, 0x003c, 0xff);
		i86out16(cpu, 0x0086, 0x4000);
		i86out16(cpu, 0x0088, 0x0000);
		i86out16(cpu, 0x008a, 0x0000);
		i86out16(cpu, 0x008c, 0xa00f);
		i86out16(cpu, 0x008e, 0xb00a);
		i86out16(cpu, 0x0090, 0x0000);
		i86out16(cpu, 0x0092, 0x0008);
		i86out16(cpu, 0x0094, 0x0000);
		i86out16(cpu, 0x0096, 0x0008);
		i86out16(cpu, 0x0098, 0x0000);
		i86out16(cpu, 0x009a, 0x0808);
		i86out16(cpu, 0x009c, 0x0040);
		i86out16(cpu, 0x009e, 0x008a);
		i86out16(cpu, 0x0050, 0x00ff);
		i86out16(cpu, 0x0056, 0x00ff);
		i86out16(cpu, 0x0054, 0x00ff);
		i86out16(cpu, 0x0058, 0x007f);
		i86out16(cpu, 0x005e, 0x007d);
		i86out16(cpu, 0x005c, 0x0034);
		i86out16(cpu, 0x0030, 0x0000);
		i86out16(cpu, 0x0032, 0xb400);
		i86out16(cpu, 0x0034, 0xb400);
		i86out16(cpu, 0x0036, 0xe003);
		i86out16(cpu, 0x003e, 0x0000);
		i86out16(cpu, 0x0040, 0x0000);
		i86out16(cpu, 0x0042, 0x0e66);
		i86out16(cpu, 0x0046, 0xe001);
		i86out16(cpu, 0x0012, 0x0002);
		i86out16(cpu, 0x0014, 0x0009);
		i86out16(cpu, 0x0016, 0x000f);
		i86out16(cpu, 0x0018, 0x0003);
		i86out16(cpu, 0x001a, 0x0000);
		i86out16(cpu, 0x001c, 0x000f);
		i86out16(cpu, 0x001e, 0x000f);
		i86out16(cpu, 0x0200, 0x1fff);
		i86out16(cpu, 0x0200, 0x0000);
		i86out8(cpu, 0x0204, 0x00);
		i86out8(cpu, 0x0206, 0x00);
		i86out8(cpu, 0x0207, 0x00);
		i86out8(cpu, 0x0243, 0x02);
		i86out16(cpu, 0x0038, 0x0000);
		i86out16(cpu, 0x003a, 0xb400);
		i86out16(cpu, 0x003c, 0xb400);
		i86out16(cpu, 0x003e, 0xc001);
		i86out16(cpu, 0x003e, 0x0000);
		i86out16(cpu, 0x0038, 0x0000);
		i86out16(cpu, 0x003a, 0xb400);
		i86out16(cpu, 0x003c, 0xb400);
		i86out16(cpu, 0x003e, 0xc001);
		i86out16(cpu, 0x003e, 0x0000);
		i86out16(cpu, 0x0222, 0x0001);
		i86out8(cpu, 0x0221, 0x0e);
		i86out8(cpu, 0x0240, 0x8f);
		i86out8(cpu, 0x02a4, 0x80);
		i86out16(cpu, 0x0038, 0x0000);
		i86out16(cpu, 0x003a, 0x0399);
		i86out16(cpu, 0x003c, 0x0399);
		i86out16(cpu, 0x003e, 0xc001);
		i86out16(cpu, 0x003e, 0x0000);
		i86out16(cpu, 0x0038, 0x0000);
		i86out16(cpu, 0x003a, 0x0399);
		i86out16(cpu, 0x003c, 0x0399);
		i86out16(cpu, 0x003e, 0xc001);
		i86out16(cpu, 0x003e, 0x0000);
		i86out16(cpu, 0x0038, 0x0000);
		i86out16(cpu, 0x003a, 0x0399);
		i86out16(cpu, 0x003c, 0x0399);
		i86out16(cpu, 0x003e, 0xc001);
		i86out16(cpu, 0x003e, 0x0000);
		i86out8(cpu, 0x02a4, 0xc0);
		i86out16(cpu, 0x0038, 0x0000);
		i86out16(cpu, 0x003a, 0xb400);
		i86out16(cpu, 0x003c, 0xb400);
		i86out16(cpu, 0x003e, 0xc001);
		i86out16(cpu, 0x003e, 0x0000);
		i86out16(cpu, 0x0038, 0x0000);
		i86out16(cpu, 0x003a, 0xb400);
		i86out16(cpu, 0x003c, 0xb400);
		i86out16(cpu, 0x003e, 0xc001);
		i86out16(cpu, 0x003e, 0x0000);
		i86out16(cpu, 0x0038, 0x0000);
		i86out16(cpu, 0x003a, 0xb400);
		i86out16(cpu, 0x003c, 0xb400);
		i86out16(cpu, 0x003e, 0xc001);
		i86out16(cpu, 0x003e, 0x0000);
		i86out16(cpu, 0x0038, 0x0000);
		i86out16(cpu, 0x003a, 0xb400);
		i86out16(cpu, 0x003c, 0xb400);
		i86out16(cpu, 0x003e, 0xc001);
		i86out16(cpu, 0x003e, 0x0000);
		i86out8(cpu, 0x0240, 0xfe);
		i86out8(cpu, 0x0280, 0xff);
		i86out16(cpu, 0x0038, 0x0000);
		i86out16(cpu, 0x003a, 0x0399);
		i86out16(cpu, 0x003c, 0x0399);
		i86out16(cpu, 0x003e, 0xc001);
		i86out16(cpu, 0x003e, 0x0000);
		i86out16(cpu, 0x0038, 0x0000);
		i86out16(cpu, 0x003a, 0x0399);
		i86out16(cpu, 0x003c, 0x0399);
		i86out16(cpu, 0x003e, 0xc001);
		i86out16(cpu, 0x003e, 0x0000);
		i86out16(cpu, 0x0038, 0x0000);
		i86out16(cpu, 0x003a, 0x0399);
		i86out16(cpu, 0x003c, 0x0399);
		i86out16(cpu, 0x003e, 0xc001);
		i86out16(cpu, 0x003e, 0x0000);
		i86out8(cpu, 0x0240, 0xff);
		i86out16(cpu, 0x005e, 0x007d);
		i86out8(cpu, 0x0242, 0x01);
		i86out8(cpu, 0x0240, 0x0f);
		i86out16(cpu, 0x005e, 0x007f);
		i86out16(cpu, 0x0038, 0x0000);
		i86out16(cpu, 0x003a, 0x0399);
		i86out16(cpu, 0x003c, 0x0399);
		i86out16(cpu, 0x003e, 0xc001);
		i86out16(cpu, 0x003e, 0x0000);
		i86out16(cpu, 0x0038, 0x0000);
		i86out16(cpu, 0x003a, 0x0399);
		i86out16(cpu, 0x003c, 0x0399);
		i86out16(cpu, 0x003e, 0xc001);
		i86out16(cpu, 0x003e, 0x0000);
		i86out16(cpu, 0x005e, 0x00ff);
		i86out16(cpu, 0x0038, 0x0000);
		i86out16(cpu, 0x003a, 0x0399);
		i86out16(cpu, 0x003c, 0x0399);
		i86out16(cpu, 0x003e, 0xc001);
		i86out16(cpu, 0x0002, 0x8000);
		i86out16(cpu, 0x003e, 0x0000);
		i86out16(cpu, 0x005e, 0x007f);
		i86out16(cpu, 0x0038, 0x0000);
		i86out16(cpu, 0x003a, 0xb400);
		i86out16(cpu, 0x003c, 0xb400);
		i86out16(cpu, 0x003e, 0xc001);
		cpu->r16.ax =
		cpu->r16.cx =
		cpu->r16.dx =
		cpu->r16.bx =
		cpu->r16.sp =
		cpu->r16.bp =
		cpu->r16.si =
		cpu->r16.di =
		cpu->r16.cs =
		cpu->r16.ds =
		cpu->r16.es =
		cpu->r16.ss = 0x0000;
		cpu->r16.f = 0x0200;
		cpu->r16.sp = 0x16b4;
		break;
	}
	return TRUE;
}

/*
	割り込みをエミュレートする
*/
int i86vector(I86stat *cpu, int vector)
{
	if(vector != 0x41)
		return FALSE;

	/*printf("vector=%02x,ah=%04x\n", vector, cpu->r8.ah);*/

	switch(cpu->r8.ah) {
	case 0x10:
		return i86subroutine(cpu, 0xe4d69);
	case 0x3a:
		return i86subroutine(cpu, 0xe50ba);
	case 0x3b:
		return i86subroutine(cpu, 0xe50c3);
	}
	return FALSE;
}

/* eof */
